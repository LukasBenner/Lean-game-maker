#! /usr/bin/env python3

from pathlib import Path
import sys, shutil, glob, distutils.dir_util

import regex
from fire import Fire
import toml

import jsonpickle


import lean_game_maker
from lean_game_maker.line_reader import FileReader
from lean_game_maker.objects import (HiddenBegin, HiddenEnd, 
    TextBegin, TextEnd,
    ExampleBegin, ExampleEnd,
    LemmaBegin, LemmaEnd,
    TheoremBegin, TheoremEnd,
    ProofBegin, ProofEnd)

from lean_game_maker.interactive_loader import interactive_server

module_path = Path(lean_game_maker.__file__).parent
interactive_path = module_path.parent / 'interactive_interface'

def render_lean_project(outdir=None, debug=False):
    try:
        leanpkg_toml = toml.load('leanpkg.toml')
    except FileNotFoundError:
        print("Couldn't find a leanpkg.toml, I give up.")
        sys.exit(1)
    toolchain = leanpkg_toml['package']['lean_version']
    lean_exec_path = Path.home() / '.elan/toolchains' / toolchain / 'bin/lean'
    paths = [str(lean_exec_path.parent / '../lib/lean/library'),
             str(Path.cwd() / 'src')]

    for dep, dep_info in leanpkg_toml.get('dependencies', []).items():
        if 'git' in dep_info:
            paths.append(str(Path('_target/deps') / dep / 'src'))
        else:
            paths.append(dep_info['path'])
    lean_path = ':'.join(paths)
    if debug:
        print("Lean executable path:", lean_exec_path)
        print("LEAN_PATH:", lean_path)

    
    

    outdir = outdir or 'html'
    Path(outdir).mkdir(exist_ok=True)


    s = interactive_server(interactive_path=interactive_path, paths=paths,
                    toolchain=toolchain, source_lib='.', outdir=outdir, debug=debug)
    s.copy_server()



    lecture_reader = FileReader([HiddenBegin, HiddenEnd,
             TextBegin, TextEnd, 
             ExampleBegin, ExampleEnd,
             LemmaBegin, LemmaEnd,
             TheoremBegin, TheoremEnd,
             ProofBegin, ProofEnd, 
             ])
    
    
    game_data = []
    world=0
    while True:
        world += 1
        if not Path(f'src/game/world{world}').exists():
            break
        world_data = []
        level=0
        while True:
            level += 1
            lean_file = Path(f'src/game/world{world}/level{level}.lean')
            if not lean_file.exists():
                break
            print(f"world : {world}, level : {level}")
            lecture_reader.read_file(str(lean_file))
            level_data = { 'raw_text' : lecture_reader.raw_text, 'objects' : lecture_reader.output }
            level_data = jsonpickle.loads(jsonpickle.dumps(level_data, unpicklable=True))
            world_data.append(level_data)
            lecture_reader.hard_reset()
        game_data.append(world_data)

    with open(str(Path(outdir) / 'game_data.js'), 'w') as f:
        temp = jsonpickle.encode(game_data, unpicklable=False)
        f.write("game_data = " + temp)



if __name__ == '__main__':
    Fire(render_lean_project)
