#! /usr/bin/env python3

from pathlib import Path
from fire import Fire
import toml, jsonpickle


import lean_game_maker
from lean_game_maker.line_reader import FileReader
from lean_game_maker.objects import (default_line_handler, 
    HiddenBegin, HiddenEnd, 
    TextBegin, TextEnd,
    TacticBegin, TacticEnd,
    AxiomBegin, AxiomEnd,
    ExampleBegin, ExampleEnd,
    LemmaBegin, LemmaEnd,
    TheoremBegin, TheoremEnd,
    ProofBegin, ProofEnd)

from lean_game_maker.interactive_loader import interactive_server

module_path = Path(lean_game_maker.__file__).parent
interactive_path = module_path.parent / 'interactive_interface'

def render_lean_project(outdir=None):
    try:
        leanpkg_toml = toml.load('leanpkg.toml')
    except FileNotFoundError:
        print("Couldn't find a leanpkg.toml, I give up.")
        return
    toolchain = leanpkg_toml['package']['lean_version']

    
    outdir = outdir or 'html'
    Path(outdir).mkdir(exist_ok=True)

    s = interactive_server(interactive_path=interactive_path,
                    toolchain=toolchain, outdir=outdir)
    if not s.copy_files():
        return



    file_reader = FileReader(default_line_handler,
            [HiddenBegin, HiddenEnd,
             TextBegin, TextEnd,
             TacticBegin, TacticEnd,
             AxiomBegin, AxiomEnd,
             ExampleBegin, ExampleEnd,
             LemmaBegin, LemmaEnd,
             TheoremBegin, TheoremEnd,
             ProofBegin, ProofEnd ])
    
    
    game_data = { 'name': leanpkg_toml['package']['name'] , 'worlds' : [] }
    world=0
    while True:
        world += 1
        if not Path(f'src/game/world{world}').exists():
            break
        world_data = { 'levels' : [] }
        level=0
        print(f"World {world} :")
        while True:
            level += 1
            lean_file = Path(f'src/game/world{world}/level{level}.lean')
            if not lean_file.exists():
                break
            print(f"\tlevel {level} ...", end="")
            file_reader.read_file(str(lean_file))
            if level == 1:
                world_data['name'] = file_reader.world_name
            if len(file_reader.output) > 0:
                level_data = {'name': file_reader.name, 'objects' : file_reader.output}
                level_data = jsonpickle.loads(jsonpickle.dumps(level_data, unpicklable=True))
                world_data['levels'].append(level_data)
            file_reader.hard_reset()
            print(f"\r\tlevel {level} ... done")

        if len(world_data['levels']) > 0:
            game_data['worlds'].append(world_data)

    with open(str(Path(outdir) / 'game_data.js'), 'w') as f:
        temp = jsonpickle.encode(game_data, unpicklable=False)
        f.write("game_data = " + temp)



if __name__ == '__main__':
    Fire(render_lean_project)
